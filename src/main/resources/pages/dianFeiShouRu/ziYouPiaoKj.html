<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/js/layui/css/layui.css">
    <link rel="stylesheet" href="/static/css/common.css"/>
    <link rel="stylesheet" href="/static/css/gdkp.css"/>
    <link rel="stylesheet" href="/static/js/font-awesome/css/font-awesome.css"/>
    <style></style>
    <!--[if lte IE 8]>
    <script src="/static/js/respond.min.js"></script>
    <![endif]-->
    <title></title>
    <style>
    </style>
</head>

<body>
<div class="padd-10 full-bg">
    <form class="layui-form search-form">
        <ul>
            <li>
                <span class="fpzl-item zyfp display-inline-block select-fpzl" th:if="${zyfp}"
                      data-value="zyfp"><label>专</label>专用发票</span>
                <span class="fpzl-item ptfp display-inline-block select-fpzl" th:if="${ptfp}"
                      data-value="ptfp"><label>普</label>普通发票</span>
                <span class="fpzl-item dzfp display-inline-block select-fpzl" th:if="${dzfp}"
                      data-value="dzfp"><label>电</label>普通发票（电子）</span>
                <span class="fpzl-item jsfp display-inline-block select-fpzl" th:if="${jsfp}"
                      data-value="jsfp"><label>卷</label>普通发票（卷）</span>
                <span class="fpzl-item  display-inline-block select-kpj active" name="kpj"
                      th:id="${kpj['id']}" th:text="${kpj['name']}"></span>
                <input type="hidden" id="kpjId" th:value="${kpj['id']}">
            </li>
            <button type="button" id="saveInvTemp" class="layui-btn bg-light-blue float-right"
                    style="background: #9E520A">发票开具
            </button>
            <button type="button" id="test" class="layui-btn bg-light-blue float-right"
                    style="background: #9E520A">test
            </button>
            <div class="clear-fixed"></div>


            <div class="clear-fixed"></div>
        </ul>
        <!--<ul>-->
        <!--<li th:each="kpj: ${kpjxxes}">-->
        <!--<span class="fpzl-item  display-inline-block select-kpj" name="kpj"-->
        <!--th:id="${kpj['id']}" th:text="${kpj['name']}"></span>-->
        <!--</li>-->
        <!--<div class="clear-fixed"></div>-->
        <!--</ul>-->
        <!--<input type="hidden" id="kpjId">-->

    </form>


    <form id="bgdkp-table-area" class="bg-white layui-form">

        <!--<img src="/images/fp-bottom.png" id="fp2">-->
        <table class="head-table">
            <tr>
                <td rowspan="3" colspan="2" style="width: 27%;"></td>
                <td rowspan="3" class="title fp-title" style="width: 46%;">
                    <h1>增值税电子普通发票<!--<img src="/images/fp1.png" id="fp1">--></h1>
                </td>
                <td class="title head-td-height"><span class="align-justify">发票代码</span></td>
                <td class="head-td-last"><span name="fpdm"></span></td>
            </tr>
            <tr>
                <td class="title head-td-height"><span class="align-justify">发票号码</span></td>
                <td class="head-td-last"><span name="fphm"></span></td>
            </tr>
            <tr>
                <td class="title head-td-height"><span class="align-justify">开票日期</span></td>
                <td class="head-td-last kp_date"></td>
            </tr>
            <tr>
                <td class="title" style="padding-left: 10px;width: 5%;"></td>
                <td>&nbsp;</td>
                <td></td>
                <td class="title head-td-height"><span class="align-justify">校验码</span></td>
                <td class="head-td-last"></td>
            </tr>
        </table>
        <div class="border-area">
            <table class="border-bottom">
                <tr class="tr-1">
                    <td rowspan="4" class="border-right width-1 title align-center">
                        <span>购</span><span>买</span><span>方</span></td>
                    <td class="width-2 "><span class="align-justify height-25 title">名称</span></td>
                    <td class="width-min">:</td>
                    <!-- <td class="width-3"><input type="text" class="bgdkp-input"></td> -->
                    <td class="gfmc-td width-3">
                        <input name="gfmc" id="gfmc" class="bgdkp-input gfmc">
                        <i class="fa fa-search popup-gfmc-table"></i>
                    </td>
                    <td rowspan="4" class="border-left-right width-1 title align-center">
                        <span>密</span><span>码</span><span>区</span></td>
                    <td rowspan="4" id="mmq"></td>
                </tr>
                <tr class="tr-2">
                    <td class="width-2"><span class="align-justify height-25 title">纳税人识别号</span></td>
                    <td class="width-min">:</td>
                    <td><span class="font-1"><input type="text" name="gfsh" id="gfsh" class="bgdkp-input"></span></td>
                </tr>
                <tr class="tr-3">
                    <td class="width-2"><span class="align-justify height-25 title">地址、电话</span></td>
                    <td class="width-min">:</td>
                    <td><input type="text" name="gfdzdh" id="gfdzdh" class="bgdkp-input"></td>
                </tr>
                <tr class="tr-4">
                    <td class="width-2"><span class="align-justify height-25 title">开户行及账号</span></td>
                    <td class="width-min">:</td>
                    <td><input type="text" name="gfyhzh" id="gfyhzh" class="bgdkp-input"></td>
                </tr>
                <tr style="display: none;">
                    <td class="width-2"><span class="align-justify height-25 title">是否在自由票白名单</span></td>
                    <td class="width-min">:</td>
                    <td><input type="text" name="zypWhiteList" id="zypWhiteList" class="bgdkp-input"></td>
                </tr>
            </table>
            <table class="border-bottom">
                <tr class="tr-5 align-center title border-bottom">
                    <td class="width-1 border-right-gray"><i class="fa fa-plus cursor-pointer" id="add-detail-tr"></i>
                    </td>
                    <td style="width: 27%">货物或应税劳务、服务名称</td>
                    <td style="width: 7.9%">规格型号</td>
                    <td style="width: 6% ">单位</td>
                    <td style="width: 11.5%;">数量</td>
                    <td style="width: 12.6%;">单价(含税)</td>
                    <td style="width: 15.8%;">金额(含税)</td>
                    <td style="width: 7%;">税率</td>
                    <td style="width: ;">税额</td>
                </tr>
                <tr class="fill-tr tr-5" id="fixed-detail-tr">
                    <td class="border-right-gray align-center"><i
                            class="fa fa-minus cursor-pointer minus-detail-tr"></i></td>
                    <td class="hwmc-td">
                        <input name="hwmc" class="bgdkp-input-detail hwmc"/>
                        <i class="fa fa-search popup-hw-table"></i>
                    </td>
                    <td><input name="ggxh" type="text" class="bgdkp-input-detail ggxh"></td>
                    <td><input name="dw" type="text" class="bgdkp-input-detail dw"></td>
                    <td class="align-right"><input name="xmsl" type="text" class="bgdkp-input-detail xmsl ver-number">
                    </td>
                    <td class="align-right"><input name="hsdj" type="text" class="bgdkp-input-detail hsdj ver-number">
                    </td>
                    <td class="align-right"><input name="hsje" type="text" class="bgdkp-input-detail hsje ver-number">
                    </td>
                    <td class="align-left">
                        <select name="sl" lay-verify="" class="bgdkp-input-detail sl" lay-filter="sl">
                            <option value="">...</option>
                        </select>
                    </td>
                    <td class="align-left"><span name="se" type="text" class="bgdkp-input-detail se"></span></td>
                    <td style="display: none;"><input type="text" class="bgdkp-input-detail  yhzcnr"></td>
                    <td style="display: none;"><input type="text" class="bgdkp-input-detail yhzclx"></td>
                    <td style="display: none;"><input type="text" name="ssflbm" class="bgdkp-input-detail ssflbm"></td>

                </tr>
                <tr id="blank-detail-tr" class="tr-5">
                    <td id="blank-detail-td" class="border-right-gray"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr class="border-bottom tr-5">
                    <td class="border-right-gray"></td>
                    <td class="align-center title">合&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;计</td>
                    <td></td>
                    <td></td>
                    <td class="align-right"></td>
                    <td class="align-right"></td>
                    <td class="align-left hjje"><span name="hjje" class="span-left-brown"></span></td>
                    <td class="align-right"></td>
                    <td class="align-left hjse"><span name="hjse" class="span-left-brown"></span></td>
                </tr>
                <tr class="border-bottom">
                    <td class="border-right-gray"></td>
                    <td class="border-right height-1-x align-center title">价税合计（大写）</td>
                    <td colspan="4" id="jshj-td">
                        <span id="big" class="span-left-brown"></span></td>
                    <td class="align-right title">（小写）</td>
                    <td colspan="2"><span id="small" class="span-left-brown"></span></td>
                </tr>
            </table>
            <table>
                <tr class="tr-1">
                    <td rowspan="4" class="border-right width-1 title align-center">
                        <span>销</span><span>售</span><span>方</span></td>
                    <td class="width-2 "><span class="align-justify height-25  title">名称</span></td>
                    <td class="width-min">:</td>
                    <td class="width-3"><span type="text" id="xxfp_xfmc" class="bgdkp-input"
                                              th:text="${enterprise.name}"></span></td>
                    <td rowspan="4" class="border-left-right width-1 title align-center"><span>备</span><span
                            style="margin-top: 20px;">注</span></td>
                    <td rowspan="4" class="vertical-top">
                        <textarea class="bgdkp-textarea"></textarea>
                    </td>
                </tr>
                <tr class="tr-2">
                    <td class="width-2"><span class="align-justify height-25  title">纳税人识别号</span></td>
                    <td class="width-min">:</td>
                    <td class="font-1"><span type="text" id="xxfp_xfsh" class="bgdkp-input"
                                             th:text="${enterprise.taxNum}"></span></td>
                </tr>
                <tr class="tr-3">
                    <td class="width-2"><span class="align-justify height-25  title">地址、电话</span></td>
                    <td class="width-min">:</td>
                    <td><span type="text" id="xxfp_xfdzdh" class="bgdkp-input" th:text="${enterprise.addr}"></span></td>
                </tr>
                <tr class="tr-4">
                    <td class="width-2"><span class="align-justify height-25  title">开户行及账号</span></td>
                    <td class="width-min">:</td>
                    <td><span type="text" id="xxfp_xfyhzh" class="bgdkp-input" th:text="${enterprise.bankInfo}"></span>
                    </td>
                </tr>
            </table>
        </div>
        <table class="foot-table">
            <tr>
                <td class="title">收款人：</td>
                <td><input type="text" id="xxfp_skr" class="bgdkp-input" th:value="${operatorName}"></td>
                <td class="title">复核：</td>
                <td><input type="text" id="xxfp_fhr" class="bgdkp-input" th:value="${operatorName}"></td>
                <td class="title">开票人：</td>
                <td><input type="text" id="xxfp_kpr" class="bgdkp-input" th:value="${operatorName}"></td>
                <td class="title">销售方(章)：</td>
                <td style="width: 15%;"></td>
            </tr>
        </table>

    </form>
</div>
<div class="popup-area">
    <div id="select-fpzl-cont" class="padd-20">
        <ul class="align-center">
            <li class="fpzl-item zyfp display-inline-block select-fpzl" th:if="${zyfp}" data-value="zyfp">
                <label>专</label>专用发票
            </li>
            <li class="fpzl-item ptfp display-inline-block select-fpzl" th:if="${ptfp}" data-value="ptfp">
                <label>普</label>普通发票
            </li>
            <li class="fpzl-item dzfp display-inline-block select-fpzl" th:if="${dzfp}" data-value="dzfp">
                <label>电</label>普通发票（电子）
            </li>
            <li class="fpzl-item jsfp display-inline-block select-fpzl" th:if="${jsfp}" data-value="jsfp">
                <label>卷</label>普通发票（卷）
            </li>
        </ul>
    </div>
</div>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/layui/layui.js"></script>
<script src="/static/js/common.js"></script>
<script type="text/javascript" src="/static/js/ziyoupiao.js"></script>
<script type="text/javascript" src="/static/js/invoice/fpkj.js"></script>
<script>
    var active = {
        refreshTotal: function () { // 刷新合计
            var hjse = 0;
            var hjje = 0;
            console.log($(".fill-tr .tr-5"));
            $(".fill-tr.tr-5").each(function () {
                var element_hsje = $(this).find('input[name="hsje"]');
                var element_se = $(this).find('span[name="se"]');
                console.log(element_hsje);
                if ("" != element_hsje.val() && undefined != element_hsje.val()) {
                    hjje = hjje + parseFloat(element_hsje.val());
                }
                if ("" != element_se.text() && undefined != element_se.text()) {
                    hjse = hjse + parseFloat(element_se.text());
                }
            });
            hjje = hjje.toFixed(2);
            hjse = hjse.toFixed(2);
            console.log("hjse:" + hjse);
            console.log("hjje:" + hjje);
            $(".hjje").find('span[name="hjje"]').text(hjje);
            $(".hjse").find('span[name="hjse"]').text(hjse);
            // 价税合计  大写 小写
            $("#big").text(smalltoBIG(hjje));
            $("#small").text(hjje);
            //开票机全部为灰色
        },
        ajaxPost: function (url, data) {// ajax post 请求
            var indexLoading;
            $.ajax({
                url: url,
                data: data,
                type: 'post',
                dataType: 'json',
                beforeSend: function () {
                    indexLoading = layer.load(2, {time: 1500, shade: [0.3, '#000']});
                },
                success: function (rlt) {
                    console.log(rlt);
                    if (rlt.status == '200') {
                        layer.close(indexLoading);
                        layer.msg(rlt.msg, {icon: 1, time: 1000, title: '温馨提示'});
                    } else {
                        layer.close(indexLoading);
                        layer.alert(rlt.msg, {icon: 2, title: '温馨提示'});
                    }
                },
                error: function () {
                    layer.close(indexLoading);
                    layer.alert('前后台数据交互异常', {icon: 2, title: '温馨提示'});
                }
            })
        }, getCurrentfpdmhm: function (InvoiceType) {
            var openCard_ret = openCard(function () {
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.close(index); //再执行关闭
            });
            if (true == openCard_ret.state) {//开卡成功
                if (51 == InvoiceType) { //电子发票 无需展示当前发票代码号码
                    $('span[name="fpdm"]').text("");
                    $('span[name="fphm"]').text("");
                } else {
                    var store_ret = getStoreInfo(InvoiceType);
                    if (true == store_ret.state) {
                        layer.msg('当前发票代码:' + store_ret.data.infoTypeCode + '<br>当前发票号码:' + store_ret.data.infoNumber, {
                            icon: 1,
                            title: '温馨提示'
                        });
                        $('span[name="fpdm"]').text(store_ret.data.infoTypeCode);
                        $('span[name="fphm"]').text(store_ret.data.infoNumber);
                    } else {
                        layer.alert("当前发票代码，号码查询失败！", {'icon': 2}, function () {
                            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                            parent.layer.close(index); //再执行关闭
                        });
                    }
                }
            }
        }
    }

    layui.use(['layer', 'form', 'autocomplete'], function () {
        var layer = layui.layer,
            autocomplete = layui.autocomplete;
        window.form = layui.form;
        var hsje_default = 0.00;//默认显示的合计金额
        var defaultType = '[[${defaultType}]]';//默认发票票种
        switch (defaultType) {
            case '51':
                $(".dzfp").addClass("active");
                $("h1").text("增值税电子普通发票");

                break;
            case '2':
                $(".ptfp").addClass("active");
                $("h1").text("增值税普通发票");

                break;
            case '0':
                $(".zyfp").addClass("active");
                $("h1").text("增值税专用发票");

                break;
            case '41':
                $(".jsfp").addClass("active");
                $("h1").text("增值税普通发票（卷）");

                break;
            default:
                break;
        }
        form.render();
        // 价税合计  大写 小写
        $("#big").text(smalltoBIG(hsje_default));
        $("#small").text(hsje_default);
        //设置 开票时间
        $(".kp_date").text(getNow());
        //加载 购方名称 自动填充功能
        autocomplete.render({
            elem: $('input[name=gfmc]')[0],
            url: '/noc/highPower/invoiceMng/gfxxDropDownList',
            template_val: '{{d.gfmc}}',
            template_txt: '<span class=\'layui-badge layui-bg-gray\'>{{d.gfmc}}&nbsp&nbsp{{d.gfsh}}</span>',
            onselect: function (resp) {
                $('input[name=gfsh]').val(resp.gfsh);
                $('input[name=gfdzdh]').val(resp.dzdh);
                $('input[name=gfyhzh]').val(resp.yhzh);
                $('input[name=zypWhiteList]').val(resp.zypWhiteList);
            }
        });
        //初始化选择发票种类
        layer.open({
            title: '请选择您要开具的发票种类',
            closeBtn: 0,
            type: 1,
            content: $('#select-fpzl-cont'),
            area: ['400px', '150px']
        });

        $('.select-fpzl').on('click', function () {
            var fpzl = $(this).attr("data-value");
            $('.select-fpzl').removeClass('active');
            layer.closeAll();
            switch (fpzl) {
                case 'dzfp':
                    $(".dzfp").addClass("active");
                    $("h1").text("增值税电子普通发票");
                    active.getCurrentfpdmhm(51);
                    break;
                case 'ptfp':
                    $(".ptfp").addClass("active");
                    $("h1").text("增值税普通发票");
                    active.getCurrentfpdmhm(2);
                    break;
                case 'zyfp':
                    $(".zyfp").addClass("active");
                    $("h1").text("增值税专用发票");
                    active.getCurrentfpdmhm(0);
                    break;
                case 'jsfp':
                    $(".jsfp").addClass("active");
                    $("h1").text("增值税普通发票（卷）");
                    active.getCurrentfpdmhm(41);
                    break;
                default:
                    break;
            }
        });
        //开票机选择
//        $('.select-kpj').on('click', function () {
//            //var fpzl = $(this).attr("data-value");
//            $('.select-kpj').removeClass('active');
//            $(this).addClass("active");
//            layer.closeAll();
//            $("#kpjId").val($(this).attr("id"));
//        });
        //$("#kpjId").val(${kpj.id});
        $("#blank-detail-td").height(208 - 26);
        var trNum = 1;
        var trHtml = '<tr class="fill-tr tr-5">' + $('#fixed-detail-tr').html() + '</tr>';
        $('#add-detail-tr').on('click', function () {
            if (trNum >= 8) {
                layer.alert('发票明细最多不超过8行！');
                return;
            }
            trNum++;
            $("#blank-detail-td").parent('tr').before(trHtml);
            form.render('select');
            changeBlankHeight(trNum);
        });

        $("#bgdkp-table-area").on('click', '.minus-detail-tr', function () {
            $(this).parents('.fill-tr').remove();
            trNum--;
            changeBlankHeight(trNum);
        });

        function changeBlankHeight(trNum) {
            $("#blank-detail-td").css('height', 208 - trNum * 26);
        }

        // 数字输入验证
        $('#bgdkp-table-area').on('input', '.hsje', function () {
            numberKeyPress($(this)[0], 2);
        });
        $('#bgdkp-table-area').on('input', '.hsdj , .xmsl', function () {
            numberKeyPress($(this)[0], 8);
        });
        // 点选购方信息
        $("#bgdkp-table-area").on('click', '.popup-gfmc-table', function () {
            layer.open({
                title: '购方信息选择',
                type: 2,
                content: '/noc/highPower/invoiceMng/selectGfxx',
                area: ['60%', '90%'],
                shadeClose: true,
            });
        })
        // 点选商品信息
        $("#bgdkp-table-area").on('click', '.popup-hw-table', function () {
            $("tr.clickActive").removeClass("clickActive");
            $(this).parents("tr").addClass("clickActive");
            var spmc = $(this).prev().val();
            if ('' != spmc && undefined != spmc) {
                // 获取浏览器存储的 spmc  判断是否存在
                var aaa = localStorage.getItem('spmc');
                if (aaa !== null) {
                    //若已存在  则清空数据
                    localStorage.removeItem('spmc');
                }
                localStorage.setItem('spmc', spmc);
            }
            layer.open({
                title: '商品信息选择',
                type: 2,
                content: '/noc/zyp/selectSpxx',
                area: ['60%', '90%'],
                shadeClose: true,
            });
        });
        //数量变化 更新金额 和 税额
        $("#bgdkp-table-area").on("keyup", ".xmsl", function () {
            $("tr.keyupActive").removeClass("keyupActive");
            $(this).parents("tr").addClass("keyupActive");
            var xmsl = $("tr.keyupActive").find('input[name="xmsl"]');
            var hsdj = $("tr.keyupActive").find('input[name="hsdj"]');
            var hsje = $("tr.keyupActive").find('input[name="hsje"]');
            var sl = $("tr.keyupActive").find('select[name="sl"]');
            var se = $("tr.keyupActive").find('span[name="se"]');
            if ("" != xmsl.val() && undefined != xmsl.val()) {
                if ("" != hsdj.val() && undefined != hsdj.val()) {
                    //单价不为空 更新金额和税额
                    hsje.val((parseFloat(xmsl.val()) * parseFloat(hsdj.val())).toFixed(2));
                    if (null != sl.val()) {
                        //se.text((parseFloat(hsje.val()) * parseFloat(sl.val())).toFixed(2));
                        se.text((parseFloat(hsje.val()) - (parseFloat(hsje.val()) / (1 + parseFloat(sl.val())))).toFixed(2));
                    }
                } else {
                    //单价为空 判断金额
                    if ("" != hsje.val() && undefined != hsje.val()) {
                        //单价为空 金额 不为空  更新单价
                        hsdj.val((parseFloat(hsje.val()) / parseFloat(xmsl.val())).toFixed(8));
                    }
                }
                console.log("数量变化！");
                console.log("数量：" + xmsl.val());
                console.log("含税单价：" + hsdj.val());
                console.log("含税金额：" + hsje.val());
            }
            //刷新总计
            active.refreshTotal();
        })
        //含税单价变化 更新金额 和 税额
        $("#bgdkp-table-area").on("keyup", ".hsdj", function () {
            $("tr.keyupActive").removeClass("keyupActive");
            $(this).parents("tr").addClass("keyupActive");
            var xmsl = $("tr.keyupActive").find('input[name="xmsl"]');
            var hsdj = $("tr.keyupActive").find('input[name="hsdj"]');
            var hsje = $("tr.keyupActive").find('input[name="hsje"]');
            var sl = $("tr.keyupActive").find('select[name="sl"]');
            var se = $("tr.keyupActive").find('span[name="se"]');
            if ("" != hsdj.val() && undefined != hsdj.val()) {
                if ("" != xmsl.val() && undefined != xmsl.val()) {
                    //数量不为空 更新金额和税额
                    hsje.val((parseFloat(xmsl.val()) * parseFloat(hsdj.val())).toFixed(2));
                    if (null != sl.val() && undefined != sl.val() && "" != sl.val()) {
                        //se.text((parseFloat(hsje.val()) * parseFloat(sl.val())).toFixed(2));
                        se.text((parseFloat(hsje.val()) - (parseFloat(hsje.val()) / (1 + parseFloat(sl.val())))).toFixed(2));
                    }
                } else {
                    //数量为空 判断金额
                    if ("" != hsje.val() && undefined != hsje.val()) {
                        //数量为空 金额 不为空  更新数量
                        xmsl.val((parseFloat(hsje.val()) / parseFloat(hsdj.val())).toFixed(8));
                    }
                }
                console.log("单价变化！");
                console.log("数量：" + xmsl.val());
                console.log("含税单价：" + hsdj.val());
                console.log("含税金额：" + hsje.val());
            }
            //刷新总计
            active.refreshTotal();
        });
        //含税金额变化 更新数量 和 单价
        $("#bgdkp-table-area").on("keyup", ".hsje", function () {
            $("tr.keyupActive").removeClass("keyupActive");
            $(this).parents("tr").addClass("keyupActive");
            var xmsl = $("tr.keyupActive").find('input[name="xmsl"]');
            var hsdj = $("tr.keyupActive").find('input[name="hsdj"]');
            var hsje = $("tr.keyupActive").find('input[name="hsje"]');
            var sl = $("tr.keyupActive").find('select[name="sl"]');
            var se = $("tr.keyupActive").find('span[name="se"]');

            if ("" != hsje.val() && undefined != hsje.val()) {
                if ("" != xmsl.val() && undefined != xmsl.val()) {
                    //数量不为空，更新 单价
                    hsdj.val((parseFloat(hsje.val()) / parseFloat(xmsl.val())).toFixed(8));
                }
                if ("" != hsdj.val() && undefined != hsdj.val()) {
                    //单价不为空，更新 数量
                    xmsl.val((parseFloat(hsje.val()) / parseFloat(hsdj.val())).toFixed(8));
                }
                //更新税额
                if (null != sl.val() && "" != sl.val() && undefined != sl.val()) {
                    //se.text((parseFloat(hsje.val()) * parseFloat(sl.val())).toFixed(2));
                    se.text((parseFloat(hsje.val()) - (parseFloat(hsje.val()) / (1 + parseFloat(sl.val())))).toFixed(2));
                }
                console.log("金额变化！");
                console.log("数量：" + xmsl.val());
                console.log("含税单价：" + hsdj.val());
                console.log("含税金额：" + hsje.val());
            } else {
                se.text("0");
            }
            //刷新总计
            active.refreshTotal();
        })
        //税率变化 更新税额
        form.on('select(sl)', function (data) {
            $("tr.keyupActive").removeClass("keyupActive");
            $(this).parents("tr").addClass("keyupActive");
            var hsje = $("tr.keyupActive").find('input[name="hsje"]');
            var se = $("tr.keyupActive").find('span[name="se"]');
            console.log(data.value);
            if ("" != data.value) {
                if ("" != hsje.val() && undefined != hsje.val()) {
                    //金额 不为空  更新税额
                    //se.text((parseFloat(hsje.val()) * parseFloat(data.value)).toFixed(2));
                    se.text((parseFloat(hsje.val()) - (parseFloat(hsje.val()) / (1 + parseFloat(sl.val())))).toFixed(2));
                } else {
                    //金额 为空  更新税额 为 0
                    se.text("0");
                }
            }
            //刷新总计
            active.refreshTotal();
        })

    });

    //选择商品数据后的回调
    function getSpxxData(ret) {
        $("tr.clickActive").find('input[name="hwmc"]').val(ret.spmc);
        $("tr.clickActive").find('input[name="ssflbm"]').val(ret.shflbm);
        //去除所有税率选项
        $("tr.clickActive").find('select[name="sl"]').find("option").remove();
        //重新添加所有税率选项
        var sls = ret.sl.split(",");
        console.log(sls);
        for (var i = 0; i < sls.length; i++) {
            var percent = decimal2percent(sls[i]);
            console.log(percent);
            $("tr.clickActive").find('select[name="sl"]').append("<option value='" + sls[i] + "'>" + percent + "</option>");
            form.render("select");
        }
        $("tr.clickActive").find(".ver-number").val("");
        $("tr.clickActive").find('span[name="se"]').text("0");
        //刷新总计
        active.refreshTotal();
    }

    function getGfxxData(ret) {
        $('input[name=gfmc]').val(ret.gfmc);
        $('input[name=gfsh]').val(ret.gfsh);
        $('input[name=gfdzdh]').val(ret.dzdh);
        $('input[name=gfyhzh]').val(ret.yhzh);
    }

    //点击按钮，提交发票信息
    $('#saveInvTemp').on('click', function () {

        var gfmc = $("#gfmc").val();
        var gfsh = $("#gfsh").val();
        var gfdzdh = $("#gfdzdh").val();
        var gfyhzh = $("#gfyhzh").val();


        var xfmc = $("#xxfp_xfmc").text();
        var xfsh = $("#xxfp_xfsh").text();
        var xfdzdh = $("#xxfp_xfdzdh").text();
        var xfyhzh = $("#xxfp_xfyhzh").text();


        var skr = $("#xxfp_skr").val();
        var fhr = $("#xxfp_fhr").val();
        var kpr = $("#xxfp_kpr").val();


        var hjje = $(".hjje").find('span[name="hjje"]').text();
        var hjse = $(".hjse").find('span[name="hjse"]').text();
        var jshj = $("#small").text();

        var bz = $("#xxfp_bz").val();
        var defaultType = $(".search-form").find('span.active').attr('data-value');//选择的发票票种
        console.log(defaultType);
        if ("zyfp" == defaultType) {
            //专票
            defaultType = 0;
        } else if ("ptfp" == defaultType) {
            //普票
            defaultType = 2;
        } else if ("dzfp" == defaultType) {
            //电子票
            defaultType = 51;
        } else if ("jsfp" == defaultType) {
            //卷票
            defaultType = 41;
        }
        //如果是专票 则购方四项必须全填
        console.log(defaultType);
        if (skr == null || skr == '' ||
            kpr == null || kpr == '' ||
            fhr == null || fhr == '') {
            layer.alert("收款人、开票人、复核人不可为空!", {icon: 2, title: '温馨提示'});
            return false;
        }
        if (defaultType == 0 && (gfmc == null || gfmc == '' ||
                gfsh == null || gfsh == '' ||
                gfdzdh == null || gfdzdh == '' ||
                gfyhzh == null || gfyhzh == '')) {
            layer.alert("当发票种类为专票时,购方信息必须全部填写!", {icon: 2, title: '温馨提示'});
            return false;
        }

        //判断此张发票是否超过开票机下的发票种类最大限额
        var kpjId = $("#kpjId").val();
        if (kpjId == null || kpjId == '') {
            layer.alert("请选择开票机!", {icon: 2, title: '温馨提示'});
            return false;
        }
        var url = '/noc/zyp/findKpjMaxMoney?kpjId=' + kpjId + "&fpzl=" + defaultType;
        var result = findKpjMaxMoney(url);
        if (result == '') {
            return false;
        } else {
            //查询成功,判断金额是否超限
            if (Number(jshj) > Number(result)) {
                layer.alert("该张发票开具的含税总金额超过该发票机对应发票类型的开票最大限额！", {icon: 2, title: '温馨提示'});
                return false;
            }

        }

        //获取各行商品信息
        var array = new Array();
        fpmxArrayPush(array);
        //var invoiceMain={};
        invoiceMain.InfoKind = defaultType;//发票类型
        invoiceMain.InfoClientName = gfmc;//购方名称
        invoiceMain.InfoClientTaxCode = gfsh;//购方税号
        invoiceMain.InfoClientAddressPhone = gfdzdh;//购方地址电话
        invoiceMain.InfoClientBankAccount = gfyhzh;//购方银行账号
        invoiceMain.InfoSellerBankAccount = xfyhzh;//销方银行账号
        invoiceMain.InfoSellerAddressPhone = xfdzdh;//销方地址电话
        invoiceMain.InfoTaxRate = "0.1";//税率
        invoiceMain.InfoNotes = bz;//备注
        invoiceMain.InfoInvoicer = kpr;//开票人
        invoiceMain.InfoChecker = fhr;//复核人，可为空
        invoiceMain.InfoCashier = skr;//收款人，可为空
        invoiceMain.InfoListName = "";//如不为空 则填“详见货物清单”
        invoiceMain.InfoBillNumber = "";//销售单据编号，可为空
        invoiceMain.BMBBH = "33.0";//税收分类编码版本号
        invoiceMain.SellerAddress = "";//见文档
        var KpArr = new Array();
        for (var index in array) {
            console.log(index);
            console.log(array[index].goodsName);
            //var invoiceDel ={};
            invoiceDel.ListGoodsName = array[index].goodsName;//商品或劳务名称
            invoiceDel.ListTaxItem = (array[index].goodsSsflbm + "").substring(0, 4);//税目 4位数字 商品所属类别
            invoiceDel.ListStandard = array[index].goodsMode;//规格型号
            invoiceDel.ListUnit = array[index].goodsUnit;//计量单位
            invoiceDel.ListNumber = array[index].goodsAmount;//数量
            invoiceDel.ListPrice = array[index].hsdj;//单价
            invoiceDel.ListAmount = array[index].moneyIncludeTax;//金额
            invoiceDel.SL = array[index].taxRate;//税率
            invoiceDel.ListPriceKind = 1;//含税标志 0-不含税 1-含税
            invoiceDel.ListTaxAmount = array[index].se;//税额 可以不传（为0） 如传入则应符合计算关系
            invoiceDel.GoodsTaxNo = array[index].goodsSsflbm;//税收分类编码
            invoiceDel.TaxPre = 0;//是否享受税收优惠政策 0-不享受 1-享受
            invoiceDel.TaxPreCon = "";//税收优惠政策内容
            invoiceDel.ZeroTax = "";//零税率标识 空：非零税率 0；出口退税 1；免税 2；不征收 3；普通零税率
            invoiceDel.CropGoodsNo = array[index].goodsSsflbm;//企业自编码
            invoiceDel.TaxDeduction = "";//扣除额 ，可为空
            KpArr.push(JSON.parse(JSON.stringify(invoiceDel)));
        }
        if (array.length <= 0) {
            layer.alert("商品明细存在问题，请仔细检查！", {icon: 2, title: '温馨提示'});
            return false;
        }

        // 对象赋值开始
        var xxfp = {};
        var mainArray = {};
        //console.log($(".search-form").find('span.active').attr('data-value'));
        mainArray.fpType = defaultType;
        var date = new Date();
        mainArray.createTime = date;
        //dataType  0  未开票
        mainArray.dataType = 0;
        mainArray.fjh = "";

        mainArray.userName = gfmc;
        mainArray.userTaxNo = gfsh;
        mainArray.userAddr = gfdzdh;
        mainArray.userBankinfo = gfyhzh;

        mainArray.xfmc = xfmc;
        mainArray.xfsh = xfsh;
        mainArray.xfdzdh = xfdzdh;
        mainArray.xfyhzh = xfyhzh;


        mainArray.skr = skr;
        mainArray.fhr = fhr;
        mainArray.kpr = kpr;
        mainArray.totalMoneyIncludeTax = Number(jshj);
        mainArray.bz = bz;
        if (array.length > 8) {
            mainArray.qdbz = 1;
        }
        else {
            mainArray.qdbz = 0;
        }
        xxfp.dlZiyoupiao = mainArray;
        xxfp.xxfpMxs = array;
        var json = JSON.stringify(xxfp);
        console.info(json);

        //根据购方信息判断是否在白名单内，如果存在则可以直接开票，不存在则比需先提交审核
        var zypWhiteList = $("#zypWhiteList").val();
        alert("zypWhiteList:" + zypWhiteList);
        if (zypWhiteList == 1) {
            //不在白名单内
            saveInvTemp(json);
        } else {
            //在白名单内
            //保存单据信息到自由票表内
            var mainId = saveInvTemp(json);
            console.log("mainId：" + mainId);
            if (mainId != '') {
                //调js接口去开票
                openJinShuiPan(JSON.stringify(invoiceMain), JSON.stringify(KpArr), null, null, null, null, defaultType, function (data) {
                    console.log("开票结果:" + JSON.stringify(data));
                    //:{"infoAmount":"0.85","infoTaxAmount":"0.15","infMonth":"undefined","typeCode":"3702141620","number":"182037","goodsListFlag":"0","retCode":"4011","machineNo":"0","retMsg":"4011-开票成功 [0000,]"}
                    //:{"infoAmount":"0.85","infoTaxAmount":"0.15","infMonth":"undefined","typeCode":"3702141620","number":"182038","goodsListFlag":"0","retCode":"4011","machineNo":"0","retMsg":"4011-开票成功 [0000,]"}
                    //开票成功，打印
                    var fpdm = data.typeCode;
                    var machineNo = data.machineNo;
                    var fphm = pad(data.number, 8);
                    //打印发票，不管是否打印都要执行后面的保存
                    printInv(defaultType, fpdm, fphm, 0, 1, null);
                    //调接口获取发票信息，保存已开的发票信息
                    QryInv(defaultType, fpdm, fphm, function (queryResult) {
                        saveFpInfo2Ykfp(queryResult, mainId, defaultType, 1, 3, machineNo, '', '');
                    }, function (msg) {
                        layer.alert('查询发票失败，失败原因:' + msg, {icon: 2, title: '温馨提示'});
                        return false;
                    });
                }, function (errorMsg) {
                    alert(3);
                    layer.alert('开票失败，失败原因:' + errorMsg, {icon: 2, title: '温馨提示'});
                    return false;
                });
//                alert(2);
//                console.log("开票结果:" + JSON.stringify(KpResult));
//                if (KpResult['retCode']=='4011') {
//                    //如果返回值等于4011说明开票成功,保存单据信息到发票表内,保存发票信息到inv表内,更新自由票表内单据状态为2
//                    json.dlZiyoupiao.id = mainId;
//                    alert(3);
//                } else {
//                    layer.alert('开票失败，失败原因:'+KpResult['retMsg'], {icon: 2, title: '温馨提示'});
//                    return false;
//                }

            }

        }


    });
    $('#test').on('click', function () {
        if (openCard().state) {
        } else {
            return false;
        }
        var fpdm = "3702141620";
        var fphm = "00182038";
        var fplx = "2";
//        var queryResult=QryInv(2, "3702141620", "00182038");
//        if(queryResult !=false){
//            saveFpInfo2Ykfp(queryResult,110,fplx,1,3,1);
//        }
        QryInv(2, "3702141620", "00182038", function (queryResult) {
            console.log("queryResult:" + queryResult);
            saveFpInfo2Ykfp(queryResult, 110, fplx, 1, 3, 1, '', '');
        }, function (msg) {
            layer.alert('查询发票失败，失败原因:' + msg, {icon: 2, title: '温馨提示'});
            return false;
        });


//        layer.confirm("是否现在打印发票代码为:" + fpdm + "\n" +
//            "发票号码为:" + fphm, {
//            btn: ['现在打印', '不打印'] //可以无限个按钮
//        }, function (index, layero) {  //确认
//            layer.close(index);
//            printInv(fplx, fpdm, fphm, 0, 1)
//        }, function (index) {//取消
//            layer.close(index);
//        });
    });

    //保存单据信息到自由票表内
    function saveInvTemp(json) {
        var result = '';
        $.ajax({
            type: 'POST',
            url: '/noc/zyp/saveInvTemp',
            cache: false,
            contentType: 'application/json;charset=utf-8',
            data: json,
            dataType: "json",
            async: false,
            success: function (data) {
                console.info(data);
                if (data.status == '200') {
                    result = data.data;
                    layer.msg(data.msg, {icon: 1, time: 500, title: '温馨提示'});
                } else {
                    layer.alert(data.msg, {icon: 2, title: '温馨提示'});
                }
            },
            error: function (error) {
                console.info(error);
                layer.alert('前后台数据交互异常', {icon: 2, title: '温馨提示'});
            }

        });
        return result;
    }

    //开票成功,保存单据信息到发票表内,保存发票信息到inv表内,更新自由票表内单据状态为2
    function saveInvTemp(json) {
        var result = '';
        $.ajax({
            type: 'POST',
            url: '/noc/zyp/saveInvTemp',
            cache: false,
            contentType: 'application/json;charset=utf-8',
            data: json,
            dataType: "json",
            async: false,
            success: function (data) {
                console.info(data);
                if (data.status == '200') {
                    result = data.data;
                    layer.msg(data.msg, {icon: 1, time: 1000, title: '温馨提示'});
                } else {
                    layer.alert(data.msg, {icon: 2, title: '温馨提示'});
                }
            },
            error: function (error) {
                console.info(error);
                layer.alert('前后台数据交互异常', {icon: 2, title: '温馨提示'});
            }

        });
        return result;
    }

    //判断此张发票是否超过开票机下的发票种类最大限额
    function findKpjMaxMoney(url) {
        var result = '';
        $.ajax({
            type: 'POST',
            url: url,
            cache: false,
            contentType: 'application/json;charset=utf-8',
            dataType: "json",
            async: false,
            success: function (data) {
                console.info(data);
                if (data.status == '200') {
                    result = data.data;
                    layer.msg(data.msg, {icon: 1, time: 1000, title: '温馨提示'});
                } else {
                    layer.alert(data.msg, {icon: 2, title: '温馨提示'});
                }
            },
            error: function (error) {
                console.info(error);
                layer.alert('前后台数据交互异常', {icon: 2, title: '温馨提示'});
            }

        });
        return result;
    }
</script>
</body>

</html>